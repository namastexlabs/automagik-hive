# Technical Specification Document: T1.0 CLI Foundation Architecture

## 1. OVERVIEW
**Objective**: Build complete CLI infrastructure from scratch with typer framework per @uvx-phase-1-foundation.md#T1.0. This is the CRITICAL blocking foundation that enables ALL other Phase 1 tasks.

**Success Metrics**: 
- Working CLI framework with <500ms startup through lazy loading
- Command routing system ready for implementation
- Integration with existing FastAPI server architecture
- Entry point configuration supporting UVX installation
- Error handling and user feedback system operational

## 2. FUNCTIONAL REQUIREMENTS

### Core CLI Framework
- **CLI Package Initialization**: Complete CLI module structure with proper imports
- **Lazy Loading System**: Defer heavy imports until commands are actually executed
- **Command Routing**: Flexible command routing framework using typer integration
- **Entry Point Integration**: Seamless integration with pyproject.toml entry points
- **FastAPI Coordination**: CLI coordinates existing FastAPI server, doesn't replace it

### User Stories
- As a developer, I want `uvx automagik-hive --help` to work with fast startup (<500ms)
- As a developer, I want CLI commands to integrate with existing FastAPI architecture
- As a developer, I want clear error messages and user guidance when commands fail  
- As a developer, I want the CLI to support both UVX and traditional installation methods
- As a developer, I want extensible command structure for future Phase 1+ commands

## 3. NON-FUNCTIONAL REQUIREMENTS

### Performance
- **Startup Time**: <500ms for help and version commands through lazy loading
- **Memory Usage**: Minimal memory footprint for simple commands
- **Import Optimization**: Heavy dependencies loaded only when needed

### Reliability
- **Error Handling**: Graceful handling of missing dependencies, configuration issues
- **User Feedback**: Clear, actionable error messages with next steps
- **Backward Compatibility**: Existing `hive` command continues to work

### Maintainability
- **Modular Design**: Separate command modules for different feature areas
- **Extensible Architecture**: Easy addition of new commands in future phases
- **Clean Separation**: Clear boundaries between CLI logic and business logic

## 4. TECHNICAL ARCHITECTURE

### System Components

#### CLI Package Structure
```python
cli/
‚îú‚îÄ‚îÄ __init__.py          # CLI package initialization with version info
‚îú‚îÄ‚îÄ main.py              # Entry point with lazy loading and typer integration
‚îú‚îÄ‚îÄ commands/            # Command modules (lazy loaded)
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py      # Command registration system
‚îÇ   ‚îú‚îÄ‚îÄ init.py          # --init command implementation (Phase 1)
‚îÇ   ‚îú‚îÄ‚îÄ workspace.py     # ./workspace command implementation (Phase 1)
‚îÇ   ‚îú‚îÄ‚îÄ genie.py         # --genie-* commands (Future Phase 2+)
‚îÇ   ‚îî‚îÄ‚îÄ agent.py         # --agent-* commands (Future Phase 2+)
‚îú‚îÄ‚îÄ core/                # Core CLI infrastructure
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py      # Core package initialization
‚îÇ   ‚îú‚îÄ‚îÄ config.py        # CLI configuration management
‚îÇ   ‚îú‚îÄ‚îÄ exceptions.py    # CLI-specific exceptions
‚îÇ   ‚îî‚îÄ‚îÄ utils.py         # CLI utilities and helpers
‚îî‚îÄ‚îÄ domain/              # Business logic (to be populated by T1.4+)
    ‚îú‚îÄ‚îÄ __init__.py      # Domain package initialization
    ‚îî‚îÄ‚îÄ workspace.py     # Workspace management logic (Future)
```

#### Core CLI Infrastructure (`cli/main.py`)
```python
"""Main CLI entry point with lazy loading optimization."""
import typer
from typing import Optional, Annotated
import sys
import importlib

# Lazy loading pattern - only import heavy dependencies when needed
app = typer.Typer(
    name="automagik-hive",
    help="Automagik Hive - Multi-Agent AI Framework CLI",
    no_args_is_help=True,
    add_completion=False,  # Optimize startup time
)

def version_callback(show_version: bool) -> None:
    """Show version information."""
    if show_version:
        # Lazy import for version info
        from cli.core.config import CLI_VERSION
        typer.echo(f"Automagik Hive CLI v{CLI_VERSION}")
        raise typer.Exit()

@app.callback()
def main(
    version: Annotated[
        Optional[bool], 
        typer.Option("--version", "-v", callback=version_callback, help="Show version")
    ] = None,
) -> None:
    """Automagik Hive CLI - Multi-Agent AI Framework."""
    pass

# Lazy command registration - commands loaded only when accessed
def get_init_command():
    """Lazy load init command."""
    from cli.commands.init import init_command
    return init_command

def get_workspace_command():
    """Lazy load workspace command."""
    from cli.commands.workspace import workspace_command
    return workspace_command

# Register commands with lazy loading
@app.command("init")
def init_wrapper(ctx: typer.Context) -> None:
    """Initialize new workspace (lazy loaded)."""
    get_init_command()(ctx)

@app.command("workspace")  
def workspace_wrapper(workspace_path: str) -> None:
    """Start existing workspace (lazy loaded)."""
    get_workspace_command()(workspace_path)

# Handle positional workspace paths (uvx automagik-hive ./my-workspace)
@app.command(hidden=True)
def default_handler(path: str) -> None:
    """Handle ./workspace-path syntax."""
    if path.startswith('./') or path.startswith('/'):
        get_workspace_command()(path)
    else:
        typer.echo(f"Unknown command: {path}")
        raise typer.Exit(1)

if __name__ == "__main__":
    app()
```

#### Configuration Management (`cli/core/config.py`)
```python
"""CLI configuration management."""
from pathlib import Path
from typing import Dict, Any
import os

# CLI version (synchronized with pyproject.toml)
CLI_VERSION = "0.1.2"

# Default configuration
DEFAULT_CONFIG = {
    "workspace": {
        "default_template": "basic-dev",
        "required_files": [".env", "docker-compose.yml"],
        "optional_files": [".claude/", ".mcp.json"],
    },
    "docker": {
        "postgres_image": "agnohq/pgvector:16",
        "default_ports": {
            "main": 8886,
            "postgres": 5532,
            "genie": 48886,
            "agent": 35532,
        },
    },
    "startup": {
        "timeout_seconds": 30,
        "health_check_interval": 2,
    }
}

class CLIConfig:
    """CLI configuration management."""
    
    def __init__(self) -> None:
        self.config = DEFAULT_CONFIG.copy()
    
    def get(self, key_path: str, default: Any = None) -> Any:
        """Get nested configuration value."""
        keys = key_path.split('.')
        value = self.config
        for key in keys:
            if isinstance(value, dict) and key in value:
                value = value[key]
            else:
                return default
        return value
    
    def workspace_exists(self, path: Path) -> bool:
        """Check if workspace is properly initialized."""
        required_files = self.get("workspace.required_files", [])
        return all((path / file).exists() for file in required_files)

# Global configuration instance
cli_config = CLIConfig()
```

#### Exception Handling (`cli/core/exceptions.py`)
```python
"""CLI-specific exceptions with user-friendly messages."""
from typing import Optional

class CLIException(Exception):
    """Base CLI exception with user guidance."""
    
    def __init__(self, message: str, help_text: Optional[str] = None) -> None:
        self.message = message
        self.help_text = help_text
        super().__init__(message)

class WorkspaceNotFoundError(CLIException):
    """Workspace directory or files not found."""
    
    def __init__(self, path: str) -> None:
        message = f"‚ùå Workspace not found or not initialized: {path}"
        help_text = "Run 'uvx automagik-hive --init' to create a new workspace"
        super().__init__(message, help_text)

class DockerNotAvailableError(CLIException):
    """Docker is not installed or not running."""
    
    def __init__(self) -> None:
        message = "‚ùå Docker is not available or not running"
        help_text = "Please install Docker and ensure the daemon is running"
        super().__init__(message, help_text)

class DatabaseConnectionError(CLIException):
    """Cannot connect to PostgreSQL database."""
    
    def __init__(self, db_url: str) -> None:
        message = f"‚ùå Cannot connect to database: {db_url}"
        help_text = "Check if PostgreSQL container is running or database is accessible"
        super().__init__(message, help_text)

class PortConflictError(CLIException):
    """Required port is already in use."""
    
    def __init__(self, port: int) -> None:
        message = f"‚ùå Port {port} is already in use"
        help_text = f"Stop the service using port {port} or choose a different port"
        super().__init__(message, help_text)
```

#### Command Implementation Structure (`cli/commands/`)

**Init Command** (`cli/commands/init.py`):
```python
"""Interactive workspace initialization command."""
import typer
from pathlib import Path
from typing import Optional

def init_command(ctx: typer.Context) -> None:
    """Initialize new Automagik Hive workspace interactively."""
    # Implementation placeholder - will be implemented in T1.5
    typer.echo("üßû Automagik Hive Workspace Initialization")
    typer.echo("This will be implemented in T1.5: Core Command Implementation")
    
    # Future implementation will include:
    # - Interactive workspace path collection
    # - API key collection (OpenAI, Anthropic, etc.)
    # - Docker vs external PostgreSQL choice
    # - Template generation (.env, docker-compose.yml, .mcp.json)
    # - Directory structure creation
    
    raise typer.Exit(0)
```

**Workspace Command** (`cli/commands/workspace.py`):
```python
"""Workspace startup and management command."""
import typer
from pathlib import Path

def workspace_command(workspace_path: str) -> None:
    """Start existing Automagik Hive workspace."""
    # Implementation placeholder - will be implemented in T1.5
    typer.echo(f"üöÄ Starting workspace: {workspace_path}")
    typer.echo("This will be implemented in T1.5: Core Command Implementation")
    
    # Future implementation will include:
    # - Workspace validation (.env, docker-compose.yml existence)
    # - Docker compose startup
    # - Health checks for all services
    # - User feedback and status reporting
    
    raise typer.Exit(0)
```

### Data Models

#### CLI Configuration Schema
```python
from pydantic import BaseModel, Field
from typing import Dict, List, Optional
from pathlib import Path

class WorkspaceConfig(BaseModel):
    """Workspace configuration model."""
    path: Path
    template: str = "basic-dev"
    required_files: List[str] = Field(default_factory=lambda: [".env", "docker-compose.yml"])
    optional_files: List[str] = Field(default_factory=lambda: [".claude/", ".mcp.json"])

class DockerConfig(BaseModel):
    """Docker configuration model."""
    postgres_image: str = "agnohq/pgvector:16"
    ports: Dict[str, int] = Field(default_factory=lambda: {
        "main": 8886,
        "postgres": 5532, 
        "genie": 48886,
        "agent": 35532,
    })

class CLISettings(BaseModel):
    """Complete CLI settings model."""
    workspace: WorkspaceConfig = Field(default_factory=WorkspaceConfig)
    docker: DockerConfig = Field(default_factory=DockerConfig)
    startup_timeout: int = 30
    health_check_interval: int = 2
```

### API Contracts

#### Entry Point Interface
```python
# pyproject.toml entry point configuration
[project.scripts]
hive = "api.serve:main"  # Existing entry point (backward compatibility)
automagik-hive = "cli.main:app"  # New CLI entry point (T1.4)
```

#### Command Interface Pattern
```python
from abc import ABC, abstractmethod
import typer

class CLICommand(ABC):
    """Base interface for all CLI commands."""
    
    @abstractmethod
    def execute(self, ctx: typer.Context) -> None:
        """Execute the command."""
        pass
    
    @abstractmethod
    def validate_prerequisites(self) -> None:
        """Validate command prerequisites."""
        pass
    
    def handle_error(self, error: Exception) -> None:
        """Handle command errors with user guidance."""
        if isinstance(error, CLIException):
            typer.echo(error.message)
            if error.help_text:
                typer.echo(f"üí° {error.help_text}")
        else:
            typer.echo(f"‚ùå Unexpected error: {error}")
        raise typer.Exit(1)
```

## 5. TEST-DRIVEN DEVELOPMENT STRATEGY

### Red-Green-Refactor Integration

#### Red Phase: Failing Tests to Write First
```python
# tests/cli/test_main.py
import pytest
from typer.testing import CliRunner
from cli.main import app

def test_cli_help_command_fast_startup():
    """Test --help command starts quickly (<500ms)."""
    import time
    runner = CliRunner()
    
    start_time = time.time()
    result = runner.invoke(app, ["--help"])
    end_time = time.time()
    
    assert result.exit_code == 0
    assert "Automagik Hive" in result.stdout
    assert (end_time - start_time) < 0.5  # <500ms startup requirement

def test_cli_version_command():
    """Test --version command shows correct version."""
    runner = CliRunner()
    result = runner.invoke(app, ["--version"])
    
    assert result.exit_code == 0
    assert "Automagik Hive CLI v" in result.stdout

def test_cli_lazy_loading_commands():
    """Test commands are lazily loaded (don't import heavy dependencies)."""
    # This test ensures heavy imports only happen when commands execute
    import sys
    
    # Clear any previous imports
    modules_before = set(sys.modules.keys())
    
    # Import CLI main (should be fast)
    from cli.main import app
    
    modules_after = set(sys.modules.keys())
    new_modules = modules_after - modules_before
    
    # Should not import heavy dependencies like FastAPI, Docker, etc.
    heavy_modules = {'fastapi', 'docker', 'sqlalchemy', 'agno'}
    imported_heavy = new_modules.intersection(heavy_modules)
    
    assert not imported_heavy, f"Heavy modules imported during CLI init: {imported_heavy}"

def test_workspace_command_placeholder():
    """Test workspace command shows placeholder message."""
    runner = CliRunner()
    result = runner.invoke(app, ["workspace", "./test-workspace"])
    
    assert result.exit_code == 0
    assert "This will be implemented in T1.5" in result.stdout

def test_init_command_placeholder():
    """Test init command shows placeholder message."""
    runner = CliRunner()
    result = runner.invoke(app, ["init"])
    
    assert result.exit_code == 0
    assert "This will be implemented in T1.5" in result.stdout
```

#### Green Phase: Minimal Implementation Approach
1. **Create CLI package structure** with proper `__init__.py` files
2. **Implement main.py** with typer integration and lazy loading
3. **Add basic configuration management** with default values
4. **Create exception classes** with user-friendly messages
5. **Implement placeholder commands** that show "coming in T1.5" messages
6. **Add entry point configuration** to pyproject.toml

#### Refactor Phase: Quality Improvement Opportunities
- **Command registration optimization**: Dynamic command discovery
- **Error handling enhancement**: More specific exception types
- **Configuration validation**: Pydantic model validation
- **Import optimization**: Further lazy loading improvements
- **Documentation addition**: Comprehensive docstrings and help text

### Test Categories

#### Unit Tests
- **CLI Configuration**: Test config loading, validation, defaults
- **Exception Handling**: Test exception creation, message formatting
- **Command Registration**: Test lazy loading, command discovery
- **Entry Point**: Test typer app initialization and configuration

#### Integration Tests  
- **Command Execution**: Test full command execution cycle
- **Error Scenarios**: Test error handling with actual CLI invocation
- **Performance**: Test startup time requirements
- **Backward Compatibility**: Test existing `hive` command still works

#### End-to-End Tests
- **UVX Installation**: Test `uvx automagik-hive --help` workflow
- **Entry Point Integration**: Test pyproject.toml entry point configuration
- **Command Routing**: Test all command routing paths work correctly

## 6. IMPLEMENTATION PHASES

### Phase 1: Foundation Structure (Day 1)
- **Create CLI package directory structure** with all required files
- **Implement basic main.py** with typer app and lazy loading pattern
- **Add core configuration management** with defaults and validation
- **Create exception hierarchy** with user-friendly error messages

### Phase 2: Command Infrastructure (Day 1-2) 
- **Implement command registration system** with lazy loading
- **Add placeholder command implementations** for init and workspace
- **Create CLI utilities and helpers** for common operations
- **Add comprehensive error handling** with user guidance

### Phase 3: Entry Point Integration (Day 2)
- **Update pyproject.toml** with new CLI entry point (T1.4 dependency)
- **Test UVX compatibility** and installation workflow
- **Validate backward compatibility** with existing `hive` command
- **Optimize startup performance** to meet <500ms requirement

## 7. EDGE CASES & ERROR HANDLING

### Boundary Conditions
- **Missing Dependencies**: Graceful handling when typer or other CLI deps missing
- **Import Failures**: Recovery when command modules fail to import
- **Configuration Corruption**: Fallback to defaults when config invalid
- **Startup Timeout**: Fast failure when CLI takes too long to initialize

### Error Scenarios
- **Invalid Commands**: Clear guidance when user provides unknown command
- **Permission Issues**: Helpful messages for file/directory permission problems
- **Port Conflicts**: Detection and guidance for port conflicts
- **Missing Docker**: Clear Docker installation guidance when needed

## 8. ACCEPTANCE CRITERIA

### Definition of Done
- [ ] Complete CLI package structure created with proper imports
- [ ] Main CLI entry point with typer integration and <500ms startup
- [ ] Lazy loading system preventing heavy imports during CLI initialization  
- [ ] Configuration management system with defaults and validation
- [ ] Exception handling with user-friendly error messages and guidance
- [ ] Placeholder command implementations for init and workspace commands
- [ ] Core utilities and helpers for CLI operations
- [ ] Entry point ready for pyproject.toml integration (T1.4 dependency)
- [ ] Unit tests covering all CLI components with >90% coverage
- [ ] Integration tests validating command execution and error handling
- [ ] Performance tests confirming <500ms startup requirement
- [ ] Documentation for CLI architecture and extension patterns

### Validation Steps
1. **Structure Validation**: Verify all CLI package files exist with proper imports
2. **Performance Validation**: Confirm `--help` and `--version` commands start <500ms
3. **Lazy Loading Validation**: Verify heavy dependencies not imported during CLI init
4. **Error Handling Validation**: Test all exception scenarios with user-friendly messages
5. **Command Registration Validation**: Verify all commands properly registered and accessible
6. **Configuration Validation**: Test config loading, defaults, and error scenarios
7. **Test Coverage Validation**: Confirm comprehensive test suite with >90% coverage
8. **Integration Readiness**: Verify CLI ready for pyproject.toml entry point integration

---

**CRITICAL SUCCESS FACTORS:**
1. **Lazy Loading**: Heavy imports deferred until command execution
2. **FastAPI Integration**: CLI coordinates with existing server, doesn't replace
3. **Extensible Design**: Easy addition of commands in future phases
4. **Error Handling**: Clear, actionable error messages with next steps
5. **Performance**: Sub-500ms startup for simple commands
6. **Test Coverage**: Comprehensive test suite ensuring reliability

This CLI foundation will enable all subsequent Phase 1 tasks (T1.1-T1.9) and provide the infrastructure for the complete UVX transformation of Automagik Hive.