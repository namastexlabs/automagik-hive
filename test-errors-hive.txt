üêù Running tests...
warning: Failed to uninstall package at .venv/lib/python3.12/site-packages/automagik_hive-0.2.0rc18.dist-info due to missing `RECORD` file. Installation may result in an incomplete environment.
Uninstalled 2 packages in 0.96ms
Installed 1 package in 11ms
=================================================================== test session starts ===================================================================
platform linux -- Python 3.12.3, pytest-8.4.1, pluggy-1.6.0
rootdir: /home/cezar/automagik/automagik-hive
configfile: pytest.ini
testpaths: tests
plugins: cov-6.2.1, mock-3.14.1, asyncio-1.1.0, anyio-4.10.0
asyncio: mode=Mode.STRICT, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collected 4772 items / 2 skipped                                                                                                                          

tests/ai/agents/template-agent/test_template_agent.py ..............                                                                                [  0%]
tests/ai/agents/test_registry.py ...........................                                                                                        [  0%]
tests/ai/agents/test_registry_ext.py ..............................                                                                                 [  1%]
tests/ai/agents/test_template_agent_factory.py ............                                                                                         [  1%]
tests/ai/agents/test_template_agent_manual_loading.py ..................                                                                            [  2%]
tests/ai/agents/tools/test_code_understanding_toolkit.py .....                                                                                      [  2%]
tests/ai/agents/tools/test_code_understanding_toolkit_coverage.py .......................................................                           [  3%]
tests/ai/teams/template-team/test_team.py ....                                                                                                      [  3%]
tests/ai/teams/test_registry.py ..............                                                                                                      [  3%]
tests/ai/tools/test_base_tool.py ..................                                                                                                 [  4%]
tests/ai/tools/test_registry.py ..............                                                                                                      [  4%]
tests/ai/tools/test_registry_execution.py ........................                                                                                  [  4%]
tests/ai/tools/test_template_tool.py ..............................                                                                                 [  5%]
tests/ai/workflows/test_registry.py ..................                                                                                              [  5%]
tests/api/dependencies/test_message_validation.py ..........................                                                                        [  6%]
tests/api/routes/test_agentos_router.py ....                                                                                                        [  6%]
tests/api/routes/test_health.py ....................                                                                                                [  6%]
tests/api/routes/test_mcp_router.py ..........................                                                                                      [  7%]
tests/api/routes/test_v1_router.py .............................                                                                                    [  8%]
tests/api/routes/test_version_router.py ............................                                                                                [  8%]
tests/api/test_agentos_config.py ..                                                                                                                 [  8%]
tests/api/test_main.py ..........................................                                                                                   [  9%]
tests/api/test_playground_unification.py ..........                                                                                                 [  9%]
tests/api/test_serve.py ....s..........ssssss....s..............s................s                                                                  [ 11%]
tests/api/test_settings.py .........................                                                                                                [ 11%]
tests/cli/commands/test_agentos_cli_command.py ..                                                                                                   [ 11%]
tests/cli/commands/test_diagnose.py ..........................                                                                                      [ 12%]
tests/cli/commands/test_genie.py ........                                                                                                           [ 12%]
tests/cli/commands/test_genie_wish_catalog.py .............                                                                                         [ 12%]
tests/cli/commands/test_health.py ......                                                                                                            [ 12%]
tests/cli/commands/test_init_docker_discovery.py FF.F.FFsss                                                                                         [ 12%]
tests/cli/commands/test_install_verification.py sssssssssssss                                                                                       [ 13%]
tests/cli/commands/test_orchestrator.py ......                                                                                                      [ 13%]
tests/cli/commands/test_postgres.py .....................sss..........                                                                              [ 14%]
tests/cli/commands/test_postgres_setup.py ......F.....                                                                                              [ 14%]
tests/cli/commands/test_service.py ..........................FF...............^C^C^CF..........                                                           [ 15%]
tests/cli/commands/test_service_api_key_collection.py ...........                                                                                   [ 15%]
tests/cli/commands/test_uninstall.py .............................                                                                                  [ 16%]
tests/cli/core/test_main_service.py ..............................................................................                                  [ 17%]
tests/cli/core/test_postgres_service.py ...............................                                                                             [ 18%]
tests/cli/test_agentos_command.py ...                                                                                                               [ 18%]
tests/cli/test_backend_detection.py ...............FF....                                                                                           [ 19%]
tests/cli/test_backend_flag.py ........F.                                                                                                           [ 19%]
tests/cli/test_backend_prompt.py FF.FFF.FFF..F.....F                                                                                                [ 19%]
tests/cli/test_docker_skip.py ....................                                                                                                  [ 20%]
tests/cli/test_main.py .....                                                                                                                        [ 20%]
tests/cli/test_utils.py ................................................                                                                            [ 21%]
tests/common/test_notifications.py ...........................................                                                                      [ 22%]
tests/common/test_startup_notifications.py ...............................                                                                          [ 22%]
tests/hooks/test_boundary_enforcer_validation.py sss                                                                                                [ 22%]
tests/integration/api/test_api_dependencies.py ..................                                                                                   [ 23%]
tests/integration/api/test_e2e_integration.py ...............                                                                                       [ 23%]
tests/integration/api/test_performance.py ............                                                                                              [ 23%]
tests/integration/auth/test_cli_credential_integration.py .                                                                                         [ 23%]
tests/integration/auth/test_credential_service_mcp_sync.py .s.................                                                                      [ 24%]
tests/integration/auth/test_credential_service_mcp_sync_edge_cases.py ................                                                              [ 24%]
tests/integration/auth/test_credential_service_mcp_sync_integration.py ..............                                                               [ 24%]
tests/integration/auth/test_credential_service_mcp_sync_specification.py ..........                                                                 [ 25%]
tests/integration/auth/test_single_credential_integration.py ...                                                                                    [ 25%]
tests/integration/cli/test_health_system.py sssssssssssssssssss                                                                                     [ 25%]
tests/integration/cli/test_makefile_uninstall.py ......                                                                                             [ 25%]
tests/integration/cli/test_postgres_integration.py sssssssssssssssssssssssssssssssssss                                                              [ 26%]
tests/integration/cli/test_service_management.py ssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssss             [ 28%]
tests/integration/config/test_config_settings.py .......................                                                                            [ 28%]
tests/integration/config/test_models_comprehensive.py .................................................                                             [ 29%]
tests/integration/config/test_server_config.py .............................                                                                        [ 30%]
tests/integration/config/test_settings_simple.py ...............s.                                                                                  [ 30%]
tests/integration/database/test_backend_integration.py ..........................................                                                   [ 31%]
tests/integration/database/test_backend_migration.py ...............                                                                                [ 31%]
tests/integration/database/test_backend_performance.py ..........F......                                                                            [ 32%]
tests/integration/database/test_backend_selection.py .............................                                                                  [ 32%]
tests/integration/e2e/test_langwatch_integration.py .sss                                                                                            [ 32%]
tests/integration/e2e/test_mcp_integration.py ......                                                                                                [ 32%]
tests/integration/e2e/test_metrics_input_validation.py .....................                                                                        [ 33%]
tests/integration/e2e/test_metrics_performance.py ..........                                                                                        [ 33%]
tests/integration/e2e/test_sync_integration_clean.py ...............                                                                                [ 33%]
tests/integration/e2e/test_version_sync.py ..s.s......                                                                                              [ 34%]
tests/integration/e2e/test_yaml_database_sync_clean.py ...........................................                                                  [ 35%]
tests/integration/knowledge/test_comprehensive_knowledge.py ...............                                                                         [ 35%]
tests/integration/knowledge/test_csv_hot_reload_comprehensive.py .......................................                                            [ 36%]
tests/integration/knowledge/test_row_based_csv_knowledge_comprehensive.py ....................................                                      [ 36%]
tests/integration/lib/test_comprehensive_utils.py ........................                                                                          [ 37%]
tests/integration/lib/test_models_comprehensive.py .......................................                                                          [ 38%]
tests/integration/lib/test_models_production_coverage.py ....................................................                                       [ 39%]
tests/integration/lib/test_production_code_analysis.py .....                                                                                        [ 39%]
tests/integration/security/test_api_routes_security.py ........................                                                                     [ 39%]
tests/integration/security/test_api_routes_unit.py ................                                                                                 [ 40%]
tests/integration/security/test_auth_dependencies.py ...........ss...................                                                               [ 40%]
tests/integration/security/test_auth_init_service.py .....................                                                                          [ 41%]
tests/integration/security/test_auth_service.py .....................                                                                               [ 41%]
tests/integration/security/test_database_service.py ........................                                                                        [ 42%]
tests/integration/security/test_database_service_unit.py ................                                                                           [ 42%]
tests/integration/test_agentos_control_plane.py ..s..s...s..                                                                                        [ 42%]
tests/integration/test_agents_real_execution.py .......sF.......                                                                                    [ 43%]
tests/integration/test_model_config_regression.py FFFFFFFFF..FFFF                                                                                   [ 43%]
tests/integration/test_model_config_regression_simple.py .......                                                                                    [ 43%]
tests/integration/test_tools_real_execution.py ..ss.........                                                                                        [ 44%]
tests/lib/auth/test_auth_service_enhanced.py ............                                                                                           [ 44%]
tests/lib/auth/test_auth_service_final_coverage.py .........                                                                                        [ 44%]
tests/lib/auth/test_cli.py ..ssss                                                                                                                   [ 44%]
tests/lib/auth/test_cli_auth.py F.....................................                                                                              [ 45%]
tests/lib/auth/test_cli_command_execution.py .....................                                                                                  [ 45%]
tests/lib/auth/test_cli_coverage.py .................................................                                                               [ 46%]
tests/lib/auth/test_cli_execution.py ............................F....                                                                              [ 47%]
tests/lib/auth/test_cli_execution_focused.py ...........                                                                                            [ 47%]
tests/lib/auth/test_credential_service.py .........................ss.............................                                                  [ 48%]
tests/lib/auth/test_credential_service_clean.py .........s.......                                                                                   [ 49%]
tests/lib/auth/test_credential_service_coverage.py ........................................................................                         [ 50%]
tests/lib/auth/test_credential_service_execution_coverage.py ............................                                                           [ 51%]
tests/lib/auth/test_credential_service_final_coverage.py ..........                                                                                 [ 51%]
tests/lib/auth/test_dependencies.py ..sss                                                                                                           [ 51%]
tests/lib/auth/test_env_file_manager.py ...........                                                                                                 [ 51%]
tests/lib/auth/test_init_service.py ..sss                                                                                                           [ 52%]
tests/lib/auth/test_service.py ............                                                                                                         [ 52%]
tests/lib/config/test_models.py ..........................                                                                                          [ 52%]
tests/lib/config/test_provider_registry.py .................................                                                                        [ 53%]
tests/lib/config/test_provider_registry_advanced.py .........................................                                                       [ 54%]
tests/lib/config/test_provider_registry_coverage.py ...........................................                                                     [ 55%]
tests/lib/config/test_provider_registry_execution.py ...........................                                                                    [ 55%]
tests/lib/config/test_schemas.py ..sss                                                                                                              [ 55%]
tests/lib/config/test_server_config.py ..sss                                                                                                        [ 56%]
tests/lib/config/test_yaml_parser.py ..............................s.........                                                                       [ 56%]
tests/lib/config/test_yaml_parser_coverage.py ............................................                                                          [ 57%]
tests/lib/config/test_yaml_parser_execution_suite.py ...............                                                                                [ 58%]
tests/lib/database/providers/test___init__.py .............                                                                                         [ 58%]
tests/lib/database/providers/test_base.py ..............................                                                                            [ 59%]
tests/lib/database/providers/test_pglite.py ..........                                                                                              [ 59%]
tests/lib/database/providers/test_postgresql.py .............                                                                                       [ 59%]
tests/lib/database/providers/test_sqlite.py .................                                                                                       [ 59%]
tests/lib/database/test___init__.py ...........                                                                                                     [ 60%]
tests/lib/database/test_backend_factory.py ............................                                                                             [ 60%]
tests/lib/knowledge/datasources/test_csv_datasource.py .........                                                                                    [ 60%]
tests/lib/knowledge/datasources/test_row_based_csv.py ...............                                                                               [ 61%]
tests/lib/knowledge/services/test_change_analyzer.py ........                                                                                       [ 61%]
tests/lib/knowledge/services/test_hash_manager.py .........                                                                                         [ 61%]
tests/lib/knowledge/test_config_aware_filter.py .......................s.........                                                                   [ 62%]
tests/lib/knowledge/test_config_aware_filter_coverage.py .......................................                                                    [ 63%]
tests/lib/knowledge/test_config_aware_filter_source_execution.py .......................                                                            [ 63%]
tests/lib/knowledge/test_csv_hot_reload.py ...........................................                                                              [ 64%]
tests/lib/knowledge/test_csv_hot_reload_coverage.py ........................................                                                        [ 65%]
tests/lib/knowledge/test_csv_hot_reload_coverage_boost.py ......................                                                                    [ 65%]
tests/lib/knowledge/test_csv_hot_reload_final_coverage.py .............                                                                             [ 66%]
tests/lib/knowledge/test_csv_hot_reload_lifecycle.py ......................                                                                         [ 66%]
tests/lib/knowledge/test_csv_hot_reload_source_execution.py ...........................                                                             [ 67%]
tests/lib/knowledge/test_hash_fix.py ..                                                                                                             [ 67%]
tests/lib/knowledge/test_knowledge_factory.py ......                                                                                                [ 67%]
tests/lib/knowledge/test_knowledge_factory_coverage_boost.py .....................                                                                  [ 67%]
tests/lib/knowledge/test_knowledge_factory_real_coverage.py ................                                                                        [ 68%]
tests/lib/knowledge/test_row_based_csv_knowledge_coverage_boost.py ....................                                                             [ 68%]
tests/lib/knowledge/test_smart_incremental_loader.py .......................................................                                        [ 69%]
tests/lib/knowledge/test_sqlite_warning_suppression.py ..FF.F..                                                                                     [ 69%]
tests/lib/logging/test_batch_logger.py .............                                                                                                [ 70%]
tests/lib/logging/test_config.py .sss                                                                                                               [ 70%]
tests/lib/logging/test_level_enforcement.py ..                                                                                                      [ 70%]
tests/lib/logging/test_progress.py .sss                                                                                                             [ 70%]
tests/lib/logging/test_session_logger.py .sss                                                                                                       [ 70%]
tests/lib/mcp/test_catalog.py .........................                                                                                             [ 70%]
tests/lib/mcp/test_config.py ............                                                                                                           [ 71%]
tests/lib/mcp/test_connection_manager.py .....................                                                                                      [ 71%]
tests/lib/mcp/test_exceptions.py ................                                                                                                   [ 71%]
tests/lib/memory/test_memory_factory.py ...                                                                                                         [ 71%]
tests/lib/memory/test_memory_init.py .....                                                                                                          [ 72%]
tests/lib/metrics/test_agno_metrics_bridge.py ...                                                                                                   [ 72%]
tests/lib/metrics/test_async_metrics_service.py .                                                                                                   [ 72%]
tests/lib/metrics/test_config.py .sss                                                                                                               [ 72%]
tests/lib/metrics/test_langwatch_integration.py ..............                                                                                      [ 72%]
tests/lib/middleware/test_error_handler.py .sss                                                                                                     [ 72%]
tests/lib/models/test_agent_metrics.py .sss                                                                                                         [ 72%]
tests/lib/models/test_base.py .sss                                                                                                                  [ 72%]
tests/lib/models/test_component_versions.py .sss                                                                                                    [ 72%]
tests/lib/models/test_version_history.py .sss                                                                                                       [ 72%]
tests/lib/services/test_agentos_service.py ........                                                                                                 [ 73%]
tests/lib/services/test_component_version_service.py ..........................................................                                     [ 74%]
tests/lib/services/test_database_service.py ............................                                                                            [ 74%]
tests/lib/services/test_database_service_error_handling.py .................                                                                        [ 75%]
tests/lib/services/test_database_service_exception_path.py ..                                                                                       [ 75%]
tests/lib/services/test_metrics_service.py ............                                                                                             [ 75%]
tests/lib/services/test_metrics_service_coverage.py ..................                                                                              [ 75%]
tests/lib/services/test_migration_service.py ......................................................                                                 [ 77%]
tests/lib/services/test_version_sync_service.py ...............................                                                                     [ 77%]
tests/lib/services/test_version_sync_service_coverage_boost.py ...............................................................................      [ 79%]
tests/lib/services/test_version_sync_service_focused.py .....................................                                                       [ 80%]
tests/lib/test_exceptions.py ..............                                                                                                         [ 80%]
tests/lib/tools/test_mcp_integration.py .............................                                                                               [ 81%]
tests/lib/tools/test_tools_registry.py ........                                                                                                     [ 81%]
tests/lib/utils/test_agno_proxy.py ................                                                                                                 [ 81%]
tests/lib/utils/test_agno_proxy_coverage.py .........................                                                                               [ 82%]
tests/lib/utils/test_agno_storage_utils.py ...........                                                                                              [ 82%]
tests/lib/utils/test_ai_root.py ........................................................                                                            [ 83%]
tests/lib/utils/test_config_validator.py ..                                                                                                         [ 83%]
tests/lib/utils/test_db_migration.py sssssss...........sss.s...s..                                                                                  [ 84%]
tests/lib/utils/test_db_migration_sqlite_suppression.py ....                                                                                        [ 84%]
tests/lib/utils/test_dynamic_model_resolver.py .....                                                                                                [ 84%]
tests/lib/utils/test_dynamic_model_resolver_coverage.py .....................................                                                       [ 85%]
tests/lib/utils/test_emoji_loader.py .........                                                                                                      [ 85%]
tests/lib/utils/test_proxy_agents.py ................F.F.....................................                                                       [ 86%]
tests/lib/utils/test_proxy_agents_model_fix.py .....                                                                                                [ 86%]
tests/lib/utils/test_proxy_teams.py ..............................................................                                                  [ 87%]
tests/lib/utils/test_proxy_teams_coverage.py .............................                                                                          [ 88%]
tests/lib/utils/test_proxy_workflows_boost.py ....................                                                                                  [ 88%]
tests/lib/utils/test_proxy_workflows_coverage.py ....................................................                                               [ 89%]
tests/lib/utils/test_proxy_workflows_final.py ...................                                                                                   [ 90%]
tests/lib/utils/test_shutdown_progress.py ............                                                                                              [ 90%]
tests/lib/utils/test_startup_orchestration.py ...............................                                                                       [ 91%]
tests/lib/utils/test_team_utils_execution.py ................                                                                                       [ 91%]
tests/lib/utils/test_user_context_helper.py .............                                                                                           [ 91%]
tests/lib/utils/test_version_factory.py ....                                                                                                        [ 91%]
tests/lib/utils/test_workflow_version_parser.py ..................................................................                                  [ 93%]
tests/lib/utils/test_yaml_cache.py ......................                                                                                           [ 93%]
tests/lib/validation/test_models.py ............................................                                                                    [ 94%]
tests/lib/validation/test_naming_conventions.py .....................                                                                               [ 95%]
tests/lib/versioning/test_agno_version_service_coverage.py .........................................................                                [ 96%]
tests/lib/versioning/test_agno_version_service_edge_cases.py .....................................                                                  [ 97%]
tests/lib/versioning/test_bidirectional_sync.py ...........................                                                                         [ 97%]
tests/lib/versioning/test_dev_mode.py ........................                                                                                      [ 98%]
tests/lib/versioning/test_file_sync_tracker.py ............................                                                                         [ 98%]
tests/lib/versioning/test_version_lifecycle_integration.py ............                                                                             [ 99%]
tests/test_global_isolation_enforcement.py ........                                                                                                 [ 99%]
tests/test_hook_validation.py .                                                                                                                     [ 99%]
tests/test_isolation_validation.py ............s.ss............                                                                                     [ 99%]
tests/test_pollution_detection_demo.py ...                                                                                                          [ 99%]
tests/test_security_validation.py .......                                                                                                           [100%]

======================================================================== FAILURES =========================================================================
________________________________________ TestDockerTemplateDiscovery.test_init_copies_docker_templates_from_source ________________________________________

self = <test_init_docker_discovery.TestDockerTemplateDiscovery object at 0x718362021340>
tmp_path = PosixPath('/tmp/pytest-of-cezar/pytest-17/test_init_copies_docker_templa0')

    def test_init_copies_docker_templates_from_source(self, tmp_path):
        """Test that init_workspace copies Docker templates from source directory.
    
        EXPECTED TO FAIL: Current implementation may not properly detect and copy
        docker/main/ directory structure during initialization.
        """
        workspace_name = str(tmp_path / "test-workspace")
        service_manager = ServiceManager()
    
        # Initialize workspace
        service_manager.init_workspace(workspace_name, force=False)
    
        # Verify Docker directory structure created
        workspace_path = Path(workspace_name)
        assert workspace_path.exists(), "Workspace should be created"
    
        docker_main_dir = workspace_path / "docker" / "main"
        assert docker_main_dir.exists(), "docker/main directory should exist"
    
        # Verify critical Docker files present
        docker_compose = docker_main_dir / "docker-compose.yml"
>       assert docker_compose.exists(), "docker-compose.yml should be copied"
E       AssertionError: docker-compose.yml should be copied
E       assert False
E        +  where False = exists()
E        +    where exists = PosixPath('/tmp/pytest-of-cezar/pytest-17/test_init_copies_docker_templa0/test-workspace/docker/main/docker-compose.yml').exists

tests/cli/commands/test_init_docker_discovery.py:56: AssertionError
------------------------------------------------------------------ Captured stdout call -------------------------------------------------------------------
üèóÔ∏è  Initializing workspace: /tmp/pytest-of-cezar/pytest-17/test_init_copies_docker_templa0/test-workspace
üìã This will copy AI component templates only
üí° You'll need to run 'install' afterwards for full setup

  ‚úÖ Agent template
  ‚úÖ Team template
  ‚úÖ Workflow template
  ‚úÖ Environment template (.env.example)
  üì• Downloading Docker configuration from GitHub...
  ‚ö†Ô∏è  Could not download Docker config: HTTP Error 429: Too Many Requests
  üí° PostgreSQL will need manual setup
  ‚ö†Ô∏è  Docker configuration unavailable - manual setup required
  ‚úÖ MCP configuration (.mcp.json)
  ‚úÖ Workspace metadata

üîç Verifying workspace structure...
‚ö†Ô∏è  Workspace verification found issues:
   ‚ùå docker/main/docker-compose.yml missing
   ‚ùå docker/main/Dockerfile missing

üí° Some components may need manual setup
   However, workspace can still be used with limitations

‚úÖ Workspace initialized: /tmp/pytest-of-cezar/pytest-17/test_init_copies_docker_templa0/test-workspace

======================================================================
üîë API KEY CONFIGURATION
======================================================================

To use AI agents, you need an API key from OpenAI or Anthropic.

üìã Choose your provider:
  1) OpenAI (GPT-4, GPT-4 Turbo, GPT-3.5)
  2) Anthropic Claude (Claude 3.5 Sonnet, Claude 3 Opus)
  3) Skip (configure manually later)

Enter your choice (1/2/3) [default: 3]: ‚ùå Failed to initialize workspace: pytest: reading from stdin while output is captured!  Consider using `-s`.
_____________________________________ TestDockerTemplateDiscovery.test_init_docker_compose_contains_postgres_service ______________________________________

self = <test_init_docker_discovery.TestDockerTemplateDiscovery object at 0x718362021580>
tmp_path = PosixPath('/tmp/pytest-of-cezar/pytest-17/test_init_docker_compose_conta0')

    def test_init_docker_compose_contains_postgres_service(self, tmp_path):
        """Test that copied docker-compose.yml contains PostgreSQL service.
    
        EXPECTED TO FAIL: Docker compose file may not be copied or may be incomplete.
        """
        workspace_name = str(tmp_path / "test-workspace")
        service_manager = ServiceManager()
    
        # Initialize workspace
        success = service_manager.init_workspace(workspace_name, force=False)
>       assert success, "Init should succeed"
E       AssertionError: Init should succeed
E       assert False

tests/cli/commands/test_init_docker_discovery.py:74: AssertionError
------------------------------------------------------------------ Captured stdout call -------------------------------------------------------------------
üèóÔ∏è  Initializing workspace: /tmp/pytest-of-cezar/pytest-17/test_init_docker_compose_conta0/test-workspace
üìã This will copy AI component templates only
üí° You'll need to run 'install' afterwards for full setup

  ‚úÖ Agent template
  ‚úÖ Team template
  ‚úÖ Workflow template
  ‚úÖ Environment template (.env.example)
  üì• Downloading Docker configuration from GitHub...
  ‚ö†Ô∏è  Could not download Docker config: HTTP Error 429: Too Many Requests
  üí° PostgreSQL will need manual setup
  ‚ö†Ô∏è  Docker configuration unavailable - manual setup required
  ‚úÖ MCP configuration (.mcp.json)
  ‚úÖ Workspace metadata

üîç Verifying workspace structure...
‚ö†Ô∏è  Workspace verification found issues:
   ‚ùå docker/main/docker-compose.yml missing
   ‚ùå docker/main/Dockerfile missing

üí° Some components may need manual setup
   However, workspace can still be used with limitations

‚úÖ Workspace initialized: /tmp/pytest-of-cezar/pytest-17/test_init_docker_compose_conta0/test-workspace

======================================================================
üîë API KEY CONFIGURATION
======================================================================

To use AI agents, you need an API key from OpenAI or Anthropic.

üìã Choose your provider:
  1) OpenAI (GPT-4, GPT-4 Turbo, GPT-3.5)
  2) Anthropic Claude (Claude 3.5 Sonnet, Claude 3 Opus)
  3) Skip (configure manually later)

Enter your choice (1/2/3) [default: 3]: ‚ùå Failed to initialize workspace: pytest: reading from stdin while output is captured!  Consider using `-s`.
_________________________________________ TestDockerTemplateDiscovery.test_init_creates_complete_docker_structure _________________________________________

self = <test_init_docker_discovery.TestDockerTemplateDiscovery object at 0x718362021b20>
tmp_path = PosixPath('/tmp/pytest-of-cezar/pytest-17/test_init_creates_complete_doc0')

    def test_init_creates_complete_docker_structure(self, tmp_path):
        """Test that init creates complete Docker directory structure.
    
        EXPECTED TO FAIL: Complete directory structure may not be created,
        leading to subsequent installation failures.
        """
        workspace_name = str(tmp_path / "test-workspace")
        service_manager = ServiceManager()
    
        # Initialize workspace
        success = service_manager.init_workspace(workspace_name, force=False)
>       assert success, "Init should succeed"
E       AssertionError: Init should succeed
E       assert False

tests/cli/commands/test_init_docker_discovery.py:149: AssertionError
------------------------------------------------------------------ Captured stdout call -------------------------------------------------------------------
üèóÔ∏è  Initializing workspace: /tmp/pytest-of-cezar/pytest-17/test_init_creates_complete_doc0/test-workspace
üìã This will copy AI component templates only
üí° You'll need to run 'install' afterwards for full setup

  ‚úÖ Agent template
  ‚úÖ Team template
  ‚úÖ Workflow template
  ‚úÖ Environment template (.env.example)
  üì• Downloading Docker configuration from GitHub...
  ‚ö†Ô∏è  Could not download Docker config: HTTP Error 429: Too Many Requests
  üí° PostgreSQL will need manual setup
  ‚ö†Ô∏è  Docker configuration unavailable - manual setup required
  ‚úÖ MCP configuration (.mcp.json)
  ‚úÖ Workspace metadata

üîç Verifying workspace structure...
‚ö†Ô∏è  Workspace verification found issues:
   ‚ùå docker/main/docker-compose.yml missing
   ‚ùå docker/main/Dockerfile missing

üí° Some components may need manual setup
   However, workspace can still be used with limitations

‚úÖ Workspace initialized: /tmp/pytest-of-cezar/pytest-17/test_init_creates_complete_doc0/test-workspace

======================================================================
üîë API KEY CONFIGURATION
======================================================================

To use AI agents, you need an API key from OpenAI or Anthropic.

üìã Choose your provider:
  1) OpenAI (GPT-4, GPT-4 Turbo, GPT-3.5)
  2) Anthropic Claude (Claude 3.5 Sonnet, Claude 3 Opus)
  3) Skip (configure manually later)

Enter your choice (1/2/3) [default: 3]: ‚ùå Failed to initialize workspace: pytest: reading from stdin while output is captured!  Consider using `-s`.
_________________________________________ TestDockerTemplateDiscovery.test_init_docker_templates_source_priority __________________________________________

self = <test_init_docker_discovery.TestDockerTemplateDiscovery object at 0x718362021310>
tmp_path = PosixPath('/tmp/pytest-of-cezar/pytest-17/test_init_docker_templates_sou0')

    def test_init_docker_templates_source_priority(self, tmp_path):
        """Test that local source templates take priority over GitHub download.
    
        EXPECTED TO FAIL: Priority logic may not be correctly implemented,
        potentially causing unnecessary network calls.
        """
        workspace_name = str(tmp_path / "test-workspace")
        service_manager = ServiceManager()
    
        # Create mock source directory with Docker templates
        project_root = Path(__file__).parent.parent.parent.parent
        docker_source = project_root / "docker"
    
        if docker_source.exists():
            # Mock GitHub download to track if it's called
            with patch("urllib.request.urlretrieve") as mock_retrieve:
                service_manager.init_workspace(workspace_name, force=False)
    
                # Verify local source used, GitHub NOT called for Docker files
                docker_urls = ["docker/main/docker-compose.yml", "docker/main/Dockerfile", "docker/main/.dockerignore"]
    
                calls = [str(call) for call in mock_retrieve.call_args_list]
    
                # GitHub should NOT be called if local Docker templates exist
                for url in docker_urls:
>                   assert not any(url in str(call) for call in calls), (
                        f"Should use local Docker templates, not download from GitHub: {url}"
                    )
E                   AssertionError: Should use local Docker templates, not download from GitHub: docker/main/docker-compose.yml
E                   assert not True
E                    +  where True = any(<generator object TestDockerTemplateDiscovery.test_init_docker_templates_source_priority.<locals>.<genexpr> at 0x71835d547840>)

tests/cli/commands/test_init_docker_discovery.py:216: AssertionError
------------------------------------------------------------------ Captured stdout call -------------------------------------------------------------------
üèóÔ∏è  Initializing workspace: /tmp/pytest-of-cezar/pytest-17/test_init_docker_templates_sou0/test-workspace
üìã This will copy AI component templates only
üí° You'll need to run 'install' afterwards for full setup

  ‚úÖ Agent template
  ‚úÖ Team template
  ‚úÖ Workflow template
  ‚úÖ Environment template (.env.example)
  üì• Downloading Docker configuration from GitHub...
  ‚ö†Ô∏è  Docker files downloaded but appear incomplete
  ‚ö†Ô∏è  Docker configuration unavailable - manual setup required
  ‚úÖ MCP configuration (.mcp.json)
  ‚úÖ Workspace metadata

üîç Verifying workspace structure...
‚ö†Ô∏è  Workspace verification found issues:
   ‚ùå docker/main/docker-compose.yml missing
   ‚ùå docker/main/Dockerfile missing

üí° Some components may need manual setup
   However, workspace can still be used with limitations

‚úÖ Workspace initialized: /tmp/pytest-of-cezar/pytest-17/test_init_docker_templates_sou0/test-workspace

======================================================================
üîë API KEY CONFIGURATION
======================================================================

To use AI agents, you need an API key from OpenAI or Anthropic.

üìã Choose your provider:
  1) OpenAI (GPT-4, GPT-4 Turbo, GPT-3.5)
  2) Anthropic Claude (Claude 3.5 Sonnet, Claude 3 Opus)
  3) Skip (configure manually later)

Enter your choice (1/2/3) [default: 3]: ‚ùå Failed to initialize workspace: pytest: reading from stdin while output is captured!  Consider using `-s`.
____________________________________________ TestDockerTemplateDiscovery.test_init_workspace_docker_validation ____________________________________________

self = <test_init_docker_discovery.TestDockerTemplateDiscovery object at 0x7183620213a0>
tmp_path = PosixPath('/tmp/pytest-of-cezar/pytest-17/test_init_workspace_docker_val0')

    def test_init_workspace_docker_validation(self, tmp_path):
        """Test that initialized workspace passes Docker validation.
    
        EXPECTED TO FAIL: Workspace may be missing critical Docker files needed
        for subsequent install and start operations.
        """
        workspace_name = str(tmp_path / "test-workspace")
        service_manager = ServiceManager()
    
        # Initialize workspace
        success = service_manager.init_workspace(workspace_name, force=False)
>       assert success, "Init should succeed"
E       AssertionError: Init should succeed
E       assert False

tests/cli/commands/test_init_docker_discovery.py:231: AssertionError
------------------------------------------------------------------ Captured stdout call -------------------------------------------------------------------
üèóÔ∏è  Initializing workspace: /tmp/pytest-of-cezar/pytest-17/test_init_workspace_docker_val0/test-workspace
üìã This will copy AI component templates only
üí° You'll need to run 'install' afterwards for full setup

  ‚úÖ Agent template
  ‚úÖ Team template
  ‚úÖ Workflow template
  ‚úÖ Environment template (.env.example)
  üì• Downloading Docker configuration from GitHub...
  ‚ö†Ô∏è  Could not download Docker config: HTTP Error 429: Too Many Requests
  üí° PostgreSQL will need manual setup
  ‚ö†Ô∏è  Docker configuration unavailable - manual setup required
  ‚úÖ MCP configuration (.mcp.json)
  ‚úÖ Workspace metadata

üîç Verifying workspace structure...
‚ö†Ô∏è  Workspace verification found issues:
   ‚ùå docker/main/docker-compose.yml missing
   ‚ùå docker/main/Dockerfile missing

üí° Some components may need manual setup
   However, workspace can still be used with limitations

‚úÖ Workspace initialized: /tmp/pytest-of-cezar/pytest-17/test_init_workspace_docker_val0/test-workspace

======================================================================
üîë API KEY CONFIGURATION
======================================================================

To use AI agents, you need an API key from OpenAI or Anthropic.

üìã Choose your provider:
  1) OpenAI (GPT-4, GPT-4 Turbo, GPT-3.5)
  2) Anthropic Claude (Claude 3.5 Sonnet, Claude 3 Opus)
  3) Skip (configure manually later)

Enter your choice (1/2/3) [default: 3]: ‚ùå Failed to initialize workspace: pytest: reading from stdin while output is captured!  Consider using `-s`.
________________________________ TestPostgresInstallErrorReporting.test_install_reports_docker_compose_location_attempted _________________________________

self = <test_postgres_setup.TestPostgresInstallErrorReporting object at 0x7183620a0590>
tmp_path = PosixPath('/tmp/pytest-of-cezar/pytest-17/test_install_reports_docker_co0')
service_manager = <cli.commands.service.ServiceManager object at 0x718362c70b30>

    def test_install_reports_docker_compose_location_attempted(self, tmp_path, service_manager):
        """Test that install reports which docker-compose.yml location it tried."""
        workspace_path = str(tmp_path)
    
        # Create .env but no Docker files
        (tmp_path / ".env.example").write_text("POSTGRES_PASSWORD=fake-test-password-not-real\n")
    
        with patch("builtins.print") as mock_print:
            with patch("builtins.input", return_value="A"):  # A = local_hybrid deployment mode
                with patch("lib.auth.credential_service.CredentialService"):
                    # Run install with verbose to see paths checked
                    service_manager.install_full_environment(workspace_path, verbose=True)
    
                    print_calls = [str(call) for call in mock_print.call_args_list]
                    output = " ".join(print_calls)
    
                    # Should mention specific paths checked
                    expected_paths = ["docker/main/docker-compose.yml", "docker-compose.yml"]
    
                    mentions_path = any(path in output for path in expected_paths)
>                   assert mentions_path, "Should mention specific docker-compose.yml paths checked"
E                   AssertionError: Should mention specific docker-compose.yml paths checked
E                   assert False

tests/cli/commands/test_postgres_setup.py:237: AssertionError
________________________________________ TestServiceManagerEnvironmentSetup.test_install_full_environment_success _________________________________________

self = <test_service.TestServiceManagerEnvironmentSetup object at 0x7183620d3710>

    def test_install_full_environment_success(self):
        """Test successful full environment installation."""
        manager = ServiceManager()
        with patch.object(manager, "_prompt_deployment_choice", return_value="full_docker"):
            with patch.object(manager, "_prompt_backend_selection", return_value="postgresql"):
                with patch.object(manager, "_store_backend_choice"):
                    resolved_path = Path("/resolved/workspace")
                    with patch("lib.auth.credential_service.CredentialService") as mock_credential_service_class:
                        mock_credential_service = mock_credential_service_class.return_value
                        mock_credential_service.install_all_modes.return_value = {}
                        with patch.object(manager, "main_service") as mock_main:
                            mock_main.install_main_environment.return_value = True
                            with patch.object(manager, "_resolve_install_root", return_value=resolved_path):
                                result = manager.install_full_environment("./test")
    
>                           assert result is True
E                           assert False is True

tests/cli/commands/test_service.py:396: AssertionError
------------------------------------------------------------------ Captured stdout call -------------------------------------------------------------------

üîß Automagik Hive Installation
==================================================

üìù Step 1/2: Generating Credentials
--------------------------------------------------

‚úÖ Credentials generated successfully
   üìÑ Configuration: /resolved/workspace/.env
   üîê Backup: /resolved/workspace/.env.master

üì¶ Step 1.5/2: Setting up Python environment
--------------------------------------------------
   üîß Initializing uv project...
   ‚ö†Ô∏è  uv command not found - please install uv first
‚ö†Ô∏è  Warning: Could not setup local Python environment
   You may need to run 'uv sync' manually in the workspace

üöÄ Step 2/2: Setting up Full Docker Mode
--------------------------------------------------

==================================================
‚úÖ Installation Complete!
==================================================

üìã Next Steps:
   1. Edit .env with your API keys:
      - ANTHROPIC_API_KEY (for Claude)
      - OPENAI_API_KEY (optional)
      - Other provider keys as needed

   2. Start the API server:
      cd /resolved/workspace
      ./dev              # Recommended: uses local launcher
      # OR
      automagik-hive dev # Alternative: direct command

   3. Access the API at:
      http://localhost:8886/docs

üí° Tips:
   - The ./dev script isolates the workspace from parent directories
   - Check .env.example for all available configuration options
==================================================

üöÄ Start the development server now? (Y/n): 
‚ùå Installation failed: pytest: reading from stdin while output is captured!  Consider using `-s`.
_________________________________ TestServiceManagerEnvironmentSetup.test_install_full_environment_uses_parent_workspace __________________________________

self = <test_service.TestServiceManagerEnvironmentSetup object at 0x7183620d3980>
tmp_path = PosixPath('/tmp/pytest-of-cezar/pytest-17/test_install_full_environment_1')

    def test_install_full_environment_uses_parent_workspace(self, tmp_path):
        """Install should pivot to parent directory when AI bundle lacks markers."""
        repo_root = tmp_path
        ai_dir = repo_root / "ai"
        ai_dir.mkdir()
        (repo_root / ".env").write_text("HIVE_DATABASE_URL=postgresql://existing")
        (repo_root / "docker").mkdir()
        docker_main = repo_root / "docker" / "main"
        docker_main.mkdir()
        (docker_main / "docker-compose.yml").write_text("version: '3'")
    
        manager = ServiceManager()
        with patch.object(manager, "_prompt_deployment_choice", return_value="local_hybrid"):
            with patch.object(manager, "_prompt_backend_selection", return_value="postgresql"):
                with patch.object(manager, "_store_backend_choice"):
                    with patch("lib.auth.credential_service.CredentialService") as mock_credential_service_class:
                        credential_instance = mock_credential_service_class.return_value
                        credential_instance.install_all_modes.return_value = {}
                        with patch.object(manager, "main_service"):
                            with patch.object(
                                manager, "_setup_local_hybrid_deployment", return_value=True
                            ) as mock_local:
                                result = manager.install_full_environment(str(ai_dir))
    
>       assert result is True
E       assert False is True

tests/cli/commands/test_service.py:426: AssertionError
------------------------------------------------------------------ Captured stdout call -------------------------------------------------------------------

üîß Automagik Hive Installation
==================================================

üìù Step 1/2: Generating Credentials
--------------------------------------------------

‚úÖ Credentials generated successfully
   üìÑ Configuration: /tmp/pytest-of-cezar/pytest-17/test_install_full_environment_1/.env
   üîê Backup: /tmp/pytest-of-cezar/pytest-17/test_install_full_environment_1/.env.master

üì¶ Step 1.5/2: Setting up Python environment
--------------------------------------------------
   üîß Initializing uv project...
   üì¶ Adding automagik-hive dependency...
   ‚úÖ Python environment configured
   üìÇ Virtual environment: /tmp/pytest-of-cezar/pytest-17/test_install_full_environment_1/.venv
   üìù Generated dev launcher script

üöÄ Step 2/2: Setting up Local Hybrid Mode
--------------------------------------------------

==================================================
‚úÖ Installation Complete!
==================================================

üìã Next Steps:
   1. Edit .env with your API keys:
      - ANTHROPIC_API_KEY (for Claude)
      - OPENAI_API_KEY (optional)
      - Other provider keys as needed

   2. Start the API server:
      cd /tmp/pytest-of-cezar/pytest-17/test_install_full_environment_1
      ./dev              # Recommended: uses local launcher
      # OR
      automagik-hive dev # Alternative: direct command

   3. Access the API at:
      http://localhost:8886/docs

üí° Tips:
   - The ./dev script isolates the workspace from parent directories
   - Check .env.example for all available configuration options
==================================================

üöÄ Start the development server now? (Y/n): 
‚ùå Installation failed: pytest: reading from stdin while output is captured!  Consider using `-s`.
___________________________________________ TestServiceManagerInitWorkspace.test_init_workspace_force_overwrite ___________________________________________

self = <test_service.TestServiceManagerInitWorkspace object at 0x7183620ea0c0>
tmp_path = PosixPath('/tmp/pytest-of-cezar/pytest-17/test_init_workspace_force_over0')

    def test_init_workspace_force_overwrite(self, tmp_path):
        """Test workspace initialization with --force flag."""
        workspace_path = tmp_path / "existing-workspace"
        workspace_path.mkdir()
        (workspace_path / "old-file.txt").write_text("old content")
    
        manager = ServiceManager()
    
        # Mock input to confirm overwrite
        with patch("builtins.input", return_value="yes"), patch("shutil.copytree"), patch("shutil.copy"):
>           result = manager.init_workspace(str(workspace_path), force=True)
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests/cli/commands/test_service.py:623: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
cli/commands/service.py:441: in init_workspace
    return self.install_full_environment(
cli/commands/service.py:731: in install_full_environment
    backend_type = backend_override or self._prompt_backend_selection()
                                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
cli/commands/service.py:1055: in _prompt_backend_selection
    print("‚ùå Invalid choice. Please enter A, B, or C.")
<frozen codecs>:327: in reset
    ???
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

signum = 2, frame = <frame at 0x71835dfca4b0, file '<frozen codecs>', line 327, code reset>

    def signal_handler(signum: int, frame: Any) -> None:
        # Let the normal shutdown process handle cleanup
>       sys.exit(0)
E       SystemExit: 0

api/serve.py:850: SystemExit

During handling of the above exception, another exception occurred:

self = <contextlib._GeneratorContextManager object at 0x71835dc5a5a0>, typ = <class 'SystemExit'>, value = SystemExit(0)
traceback = <traceback object at 0x717ca390e640>

    def __exit__(self, typ, value, traceback):
        if typ is None:
            try:
                next(self.gen)
            except StopIteration:
                return False
            else:
                try:
                    raise RuntimeError("generator didn't stop")
                finally:
                    self.gen.close()
        else:
            if value is None:
                # Need to force instantiation so we can reliably
                # tell if we get the same exception back
                value = typ()
            try:
>               self.gen.throw(value)

/usr/lib/python3.12/contextlib.py:158: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

signum = 2, frame = <frame at 0x718362a2db60, file '<frozen codecs>', line 319, code decode>

    def signal_handler(signum: int, frame: Any) -> None:
        # Let the normal shutdown process handle cleanup
>       sys.exit(0)
E       SystemExit: 0

api/serve.py:850: SystemExit
---------------------------------------------------------------- Captured stdout teardown -----------------------------------------------------------------
